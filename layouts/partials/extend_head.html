<!-- Mobile-First Menu JavaScript (Progressive Enhancement) -->
<script>
console.log('[MENU] Script loading...');
(function() {
    'use strict';
    
    // Progressive Enhancement: Mark that JS is available
    document.documentElement.classList.add('js-enabled');
    console.log('[MENU] js-enabled class added');
    
    let menuBtn = null;
    let overlay = null;
    let menu = null;
    const MOBILE_BREAKPOINT = 1024;
    
    // Named functions for event handlers (prevents memory leaks)
    function handleEscKey(e) {
        if (e.key === 'Escape' && menu && menu.classList.contains('show-menu')) {
            toggleMenu();
        }
    }
    
    function handleMenuClick(e) {
        // Event delegation - close menu when clicking on links or their children
        const link = e.target.closest('a');
        if (link && menu.contains(link)) {
            toggleMenu();
        }
    }
    
    function isMobile() {
        return window.innerWidth < MOBILE_BREAKPOINT;
    }
    
    function cleanup() {
        // Remove menu-open class from body
        document.body.classList.remove('menu-open');
        
        // Clean menu state
        if (menu) {
            menu.classList.remove('show-menu');
        }
        
        // Clean button state
        if (menuBtn) {
            menuBtn.classList.remove('active');
            menuBtn.setAttribute('aria-expanded', 'false');
        }
        
        // Clean overlay
        if (overlay) {
            overlay.classList.remove('show');
            overlay.setAttribute('aria-hidden', 'true');
        }
    }
    
    function toggleMenu() {
        if (!menu || !menuBtn || !overlay) return;
        
        const isOpen = menuBtn.classList.contains('active');
        
        menuBtn.classList.toggle('active');
        menu.classList.toggle('show-menu');
        overlay.classList.toggle('show');
        document.body.classList.toggle('menu-open');
        
        // Update ARIA
        menuBtn.setAttribute('aria-expanded', !isOpen);
        overlay.setAttribute('aria-hidden', isOpen);
    }
    
    function createMobileMenu() {
        const nav = document.querySelector('.nav');
        if (!nav || menuBtn) return; // Already created
        
        // Create button
        menuBtn = document.createElement('button');
        menuBtn.className = 'mobile-menu-btn';
        menuBtn.setAttribute('aria-label', 'Menu');
        menuBtn.setAttribute('aria-expanded', 'false');
        menuBtn.innerHTML = '<span></span><span></span><span></span>';
        nav.appendChild(menuBtn);
        
        // Create overlay
        overlay = document.createElement('div');
        overlay.className = 'menu-overlay';
        overlay.setAttribute('aria-hidden', 'true');
        document.body.appendChild(overlay);
        
        // Get menu
        menu = document.getElementById('menu');
        if (!menu) return;
        
        // Events - all named functions, added once
        menuBtn.addEventListener('click', toggleMenu);
        overlay.addEventListener('click', toggleMenu);
        menu.addEventListener('click', handleMenuClick); // Event delegation with closest()
        document.addEventListener('keydown', handleEscKey);
    }
    
    function removeMobileMenu() {
        // Cleanup state first
        cleanup();
        
        // Remove ALL event listeners - PREVENTS MEMORY LEAKS
        if (menu) {
            menu.removeEventListener('click', handleMenuClick);
        }
        document.removeEventListener('keydown', handleEscKey);
        
        // Remove DOM elements
        if (menuBtn && menuBtn.parentNode) {
            menuBtn.parentNode.removeChild(menuBtn);
            menuBtn = null;
        }
        
        if (overlay && overlay.parentNode) {
            overlay.parentNode.removeChild(overlay);
            overlay = null;
        }
        
        // Clear menu reference
        menu = null;
    }
    
    function handleResize() {
        if (isMobile()) {
            // Mobile/Tablet - ensure menu button exists
            createMobileMenu();
        } else {
            // Desktop - remove menu button and cleanup
            removeMobileMenu();
        }
    }
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('[MENU] DOM loaded, width:', window.innerWidth, 'isMobile:', isMobile());
        handleResize();
    });
    
    // Handle resize and orientation change
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(handleResize, 150);
    });
    
    window.addEventListener('orientationchange', function() {
        setTimeout(handleResize, 200);
    });
})();
</script>

<!-- Conditional Chroma CSS Loading (Lazy Load) -->
<script>
(function() {
    'use strict';
    
    // Check if page has code blocks
    function hasCodeBlocks() {
        return !!document.querySelector('.highlight, pre code, .chroma, pre.chroma');
    }
    
    // Load Chroma CSS dynamically
    function loadChromaCSS() {
        if (document.getElementById('chroma-lazy-css')) {
            return; // Already loaded
        }
        
        // Load main Chroma styles
        const link1 = document.createElement('link');
        link1.id = 'chroma-lazy-css';
        link1.rel = 'stylesheet';
        link1.href = '/css/chroma-lazy.css';
        document.head.appendChild(link1);
        
        // Load Chroma modifications
        const link2 = document.createElement('link');
        link2.id = 'chroma-mod-lazy-css';
        link2.rel = 'stylesheet';
        link2.href = '/css/chroma-mod-lazy.css';
        document.head.appendChild(link2);
        
        console.log('[Chroma] Syntax highlighting CSS loaded (lazy) - ~5KB saved on pages without code');
    }
    
    // Initialize on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', function() {
        if (hasCodeBlocks()) {
            loadChromaCSS();
        } else {
            console.log('[Chroma] No code blocks found, CSS not loaded (bandwidth saved!)');
        }
    });
})();
</script>

<!-- WebP Support Detection -->
<script src="/js/webp-support.js"></script>

<!-- Service Worker Registration (PWA + Offline Support) -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#161b2e">
<script>
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js', { scope: '/' })
            .then(function(registration) {
                console.log('[SW] Service Worker registered successfully:', registration.scope);
                
                // Check for updates
                registration.addEventListener('updatefound', function() {
                    const newWorker = registration.installing;
                    console.log('[SW] New Service Worker found, installing...');
                    
                    newWorker.addEventListener('statechange', function() {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            console.log('[SW] New version available! Reload to update.');
                        }
                    });
                });
            })
            .catch(function(error) {
                console.error('[SW] Service Worker registration failed:', error);
            });
    });
}
</script>
